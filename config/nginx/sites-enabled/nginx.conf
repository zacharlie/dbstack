map $http_upgrade $connection_upgrade {
  default upgrade;
  '' close;
}

upstream pgadmin {
    server pgadmin:80;
}

upstream postgrest {
    server postgrest:3000;
}

upstream postgraphile {
    server postgraphile:5000;
}

upstream swagger {
    server swagger:8080;
}

upstream grafana {
    server grafana:3000;
}

upstream prometheus {
    server prometheus:9090;
}

upstream web {
   server web:9000;
}

upstream tiles {
   server tiles:7800;
}

upstream advisor {
    server advisor:8080;
}

upstream monitor {
    server monitor:3001;
}

server {
    # redirect to https
    listen 80;
    listen [::]:80;
    return 301 https://$host$request_uri;
}

server {
    listen      443 ssl http2;
    listen      [::]:443 ssl http2;
    include     ssl/certificates.conf;
    include     ssl/ssl-params.conf;

    error_log /dev/stdout info;
    access_log /dev/stdout;

    # server_name _;

    root /usr/share/nginx/html/www;
    index index.html;

    # default max upload size
    client_max_body_size        5000;

    keepalive_timeout  500;
    proxy_connect_timeout       600;
    proxy_send_timeout          600;
    send_timeout                600;
    client_header_timeout       600;
    client_body_timeout         600;
    fastcgi_read_timeout        300;

    location / {

        try_files $uri $uri/ =404;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

    }

    location /api {
        proxy_pass http://swagger/api;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;

        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /swagger;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    # Needs trailing slash or returns 404
    # Use trailing slash to redirect /rest to /rest/
    location /rest/ {
        rewrite /rest(.*) $1 break;
        proxy_pass http://postgrest/;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;

        # https://postgrest.org/en/stable/admin.html#hardening-postgrest
        default_type  application/json;
        proxy_hide_header Content-Location;
        add_header Content-Location  /api/$upstream_http_content_location;
        proxy_set_header  Connection "";

        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /postgrest;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    location /graphql {
        proxy_pass http://postgraphile/graphql;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /graphql;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    location /graphiql {
        proxy_pass http://postgraphile/graphiql;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /graphiql;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    location /admin {
        proxy_pass http://pgadmin/;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /admin;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    location /browser {
        proxy_pass http://filebrowser:80;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /filebrowser;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Set large max file size for GIS uploads
        client_max_body_size 2G;
    }

    location /advisor {
        proxy_pass http://advisor$request_uri;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /advisor;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        # Set large max file size for GIS uploads
        client_max_body_size 2G;
    }

    location /prometheus {
        proxy_pass http://prometheus/prometheus;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /prometheus;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    location /web/ {
        rewrite /web(.*) $1 break;
        proxy_pass http://web;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /web;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

   }

    location /tiles/ {
        rewrite /tiles(.*) $1 break;
        proxy_pass http://tiles;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /tiles;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    location /grafana {
        proxy_pass http://grafana;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /grafana;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;
        proxy_set_header X-WEBAUTH-USER $remote_user;
        proxy_set_header Authorization "";

    }

    location /uptime {
        proxy_pass http://monitor/uptime;
        # proxy_intercept_errors on;
        # proxy_next_upstream error http_502;
        proxy_set_header    Host            $host;
        proxy_set_header    X-Real-IP       $remote_addr;
        proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;
        proxy_set_header Host $host;

        port_in_redirect off;
        proxy_connect_timeout 600;
        proxy_set_header X-Script-Name /uptime;

        add_header 'Content-Security-Policy' 'upgrade-insecure-requests';
        add_header 'Access-Control-Allow-Origin' '*';
        include     /etc/nginx/conf.d/includes/cors-settings.conf;

        auth_basic "Restricted Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}